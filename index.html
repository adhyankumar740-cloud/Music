<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Music</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        :root { --primary: #1DB954; --bg: #121212; --card: #181818; }
        body { margin:0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #fff; padding-bottom: 120px; }
        .header { padding: 20px; text-align: center; color: var(--primary); font-size: 28px; font-weight: bold; border-bottom: 1px solid #333; }
        
        #loginPanel { max-width: 300px; margin: 50px auto; text-align: center; background: var(--card); padding: 30px; border-radius: 10px; }
        input { width: 90%; padding: 10px; margin: 10px 0; border-radius: 5px; border: none; background: #333; color: white; }
        button { background: var(--primary); color: black; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; margin: 5px; }

        .container { padding: 15px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .card { background: var(--card); border-radius: 8px; padding: 10px; cursor: pointer; transition: 0.3s; }
        .card:hover { background: #282828; }
        .card img { width: 100%; border-radius: 5px; }
        .card p { font-size: 14px; margin: 10px 0 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Fix for Black Screen: Player Area */
        #video-container { width: 100%; max-width: 600px; margin: 10px auto; border-radius: 10px; overflow: hidden; background: #000; aspect-ratio: 16/9; }
        
        .player-bar { position: fixed; bottom: 0; width: 100%; background: #181818; border-top: 1px solid #333; padding: 15px 0; z-index: 100; }
        .controls { display: flex; justify-content: center; align-items: center; gap: 20px; }
        #seek { width: 80%; display: block; margin: 10px auto; accent-color: var(--primary); }
    </style>
</head>
<body>

<div class="header">PIXEL MUSIC</div>

<div id="loginPanel">
    <h2>Welcome</h2>
    <input id="username" placeholder="Username">
    <input id="password" type="password" placeholder="Password">
    <button onclick="auth('register')">Register</button>
    <button onclick="auth('login')">Login</button>
    <p id="msg"></p>
</div>

<div id="app" style="display:none;">
    <div id="video-container">
        <div id="yt-player"></div>
    </div>

    <div class="container">
        <h3 id="now-playing">Select a song</h3>
        <div class="grid" id="song-grid"></div>
        
        <hr style="border:0.5px solid #333; margin: 20px 0;">
        <h3>My Playlists</h3>
        <input id="plName" placeholder="Playlist Name" style="width:200px">
        <button onclick="createPlaylist()">Create</button>
        <div id="playlists-list"></div>
    </div>

    <div class="player-bar">
        <input type="range" id="seek" value="0" min="0" step="1" onchange="manualSeek(this.value)">
        <div class="controls">
            <button onclick="yt.seekTo(yt.getCurrentTime()-10)">-10s</button>
            <button id="playBtn" onclick="togglePlay()" style="font-size: 20px;">â–¶</button>
            <button onclick="yt.seekTo(yt.getCurrentTime()+10)">+10s</button>
            <button onclick="joinJam()" title="Sync with Room">ðŸ‘¥ Jam</button>
        </div>
    </div>
</div>

<script>
    let yt, user, currentVideoId = "", room = "global";
    const socket = io();

    function onYouTubeIframeAPIReady() {
        yt = new YT.Player('yt-player', {
            height: '100%', width: '100%',
            playerVars: { 'autoplay': 0, 'controls': 0 },
            events: { 'onStateChange': onStateChange }
        });
    }

    async function auth(type) {
        const u = document.getElementById("username").value;
        const p = document.getElementById("password").value;
        const res = await fetch(`/api/${type}`, {
            method: "POST", headers: {"Content-Type":"application/json"},
            body: JSON.stringify({username:u, password:p})
        });
        const data = await res.json();
        if(data.ok) {
            if(type === 'login') {
                user = data.username;
                document.getElementById("loginPanel").style.display = "none";
                document.getElementById("app").style.display = "block";
                loadSongs();
                loadPlaylists();
            } else { alert("Registered! Now Login."); }
        } else alert(data.error);
    }

    async function loadSongs() {
        const cfg = await (await fetch("/api/config")).json();
        const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=trending%20songs&type=video&maxResults=12&key=${cfg.yt}`);
        const data = await res.json();
        const grid = document.getElementById("song-grid");
        grid.innerHTML = data.items.map(v => `
            <div class="card" onclick="playVideo('${v.id.videoId}', '${v.snippet.title.replace(/'/g, "")}')">
                <img src="${v.snippet.thumbnails.medium.url}">
                <p>${v.snippet.title}</p>
            </div>
        `).join('');
    }

    function playVideo(id, title) {
        currentVideoId = id;
        yt.loadVideoById(id);
        document.getElementById("now-playing").innerText = title;
        document.getElementById("playBtn").innerText = "â¸";
        socket.emit("play", {roomId: room, videoId: id, time: 0, playing: true});
    }

    function togglePlay() {
        const state = yt.getPlayerState();
        if(state === 1) { yt.pauseVideo(); document.getElementById("playBtn").innerText = "â–¶"; }
        else { yt.playVideo(); document.getElementById("playBtn").innerText = "â¸"; }
    }

    function manualSeek(val) { yt.seekTo(val, true); }

    function onStateChange(e) {
        if(e.data === 1) { // Playing
            const seek = document.getElementById("seek");
            seek.max = yt.getDuration();
            setInterval(() => { seek.value = yt.getCurrentTime(); }, 1000);
        }
    }

    function joinJam() { socket.emit("join", room); alert("Joined Jam Room!"); }
    socket.on("play", d => { yt.loadVideoById(d.videoId, d.time); });

    async function createPlaylist() {
        const name = document.getElementById("plName").value;
        await fetch("/api/playlist", {
            method:"POST", headers:{"Content-Type":"application/json"},
            body: JSON.stringify({username: user, name})
        });
        loadPlaylists();
    }

    async function loadPlaylists() {
        const res = await fetch("/api/playlists/" + user);
        const data = await res.json();
        document.getElementById("playlists-list").innerHTML = data.map(p => `
            <div style="background:#222; padding:10px; margin:5px; border-radius:5px;">
                <strong>${p.name}</strong> (${p.songs.length} songs)
            </div>
        `).join('');
    }
</script>
</body>
</html>
