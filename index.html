<!DOCTYPE html>
<html lang="en">
<head>
    <title>PixelStream Group Player</title>
    <style>
        /* (‡§Ü‡§™‡§ï‡•á ‡§™‡•Å‡§∞‡§æ‡§®‡•á CSS stlyes ‡§Ø‡§π‡§æ‡§Å ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç) */
        :root { /* ... styles ... */ }
        body { /* ... styles ... */ }
        .container { /* ... styles ... */ }
        h1 { /* ... styles ... */ }
        p { /* ... styles ... */ }
        .audio-player-wrapper { /* ... styles ... */ }
        audio { /* ... styles ... */ }
        /* (Customize audio controls styles ‡§Ø‡§π‡§æ‡§Å ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç) */
        .footer-text { margin-top: 25px; font-size: 0.9em; color: #888; }
        #status-message { color: #ffeb3b; margin-top: 15px; font-size: 1.0em; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
</head>
<body>
    <div class="container">
        <h1>üéß Group PixelStream</h1>
        <p>Listen synchronously with your group.</p>
        
        <div class="audio-player-wrapper">
            <audio id="groupAudio" controls>
                <source src="https://music-bva7.onrender.com/stream-audio" type="audio/mpeg">
                Your browser does not support audio streaming.
            </audio>
        </div>
        
        <div id="status-message">Connecting...</div>

        <p class="footer-text">Powered by SocketIO & Telegram Mini Apps</p>
    </div>

    <script>
        const audio = document.getElementById('groupAudio');
        const statusMessage = document.getElementById('status-message');
        
        // 1. URL ‡§∏‡•á chat_id ‡§®‡§ø‡§ï‡§æ‡§≤‡•á‡§Ç
        const urlParams = new URLSearchParams(window.location.search);
        const chat_id = urlParams.get('chat_id');

        if (!chat_id) {
            statusMessage.textContent = "Error: Group ID not found. Open via Telegram bot /play command.";
        }
        
        // 2. SocketIO ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
        // FIX: SocketIO URL ‡§ï‡•ã ‡§Ü‡§™‡§ï‡•á Render Backend URL ‡§™‡§∞ ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
        const BACKEND_URL = "https://music-bva7.onrender.com/"; 
        const socket = io(BACKEND_URL, { transports: ['websocket', 'polling'] });
        
        // 3. SocketIO ‡§á‡§µ‡•á‡§Ç‡§ü ‡§π‡•à‡§Ç‡§°‡§≤‡§ø‡§Ç‡§ó
        
        socket.on('connect', () => {
            statusMessage.textContent = "Connected. Joining group...";
            // ‡§ó‡•ç‡§∞‡•Å‡§™ ‡§Æ‡•á‡§Ç ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§ï‡•ã ‡§ï‡§Æ‡§æ‡§Ç‡§° ‡§≠‡•á‡§ú‡•á‡§Ç
            socket.emit('join_group', { chat_id: chat_id });
        });

        socket.on('status_message', (data) => {
            console.log(data.message);
            statusMessage.textContent = data.message;
        });

        // 4. ‡§∏‡§ø‡§Ç‡§ï‡•ç‡§∞‡§®‡§æ‡§á‡§ú‡§º‡•á‡§∂‡§® ‡§ï‡§Ç‡§ü‡•ç‡§∞‡•ã‡§≤ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç
        socket.on('sync_control', (data) => {
            // Check if player is currently controlled by user to avoid loop
            if (audio.userControl === true) return; 

            const action = data.action;
            const time = data.time;

            // ‡§Ö‡§ó‡§∞ ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∏‡•á ‡§ï‡§Æ‡§æ‡§Ç‡§° ‡§Ü‡§Ø‡§æ ‡§π‡•à, ‡§§‡•ã ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§ï‡§Ç‡§ü‡•ç‡§∞‡•ã‡§≤ ‡§ï‡•ã ‡§Ö‡§®‡§¶‡•á‡§ñ‡§æ ‡§ï‡§∞‡•á‡§Ç
            audio.userControl = false; 

            if (action === 'play') {
                // ‡§ü‡§æ‡§á‡§Æ ‡§ï‡•ã ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§ü‡§æ‡§á‡§Æ ‡§™‡§∞ ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
                if (Math.abs(audio.currentTime - time) > 1) { 
                    audio.currentTime = time;
                    statusMessage.textContent = `Synced: Playing at ${Math.floor(time)}s`;
                }
                audio.play().catch(e => console.error("Play failed:", e));

            } else if (action === 'pause') {
                audio.pause();
                statusMessage.textContent = `Synced: Paused at ${Math.floor(time)}s`;
            }
        });
        
        // 5. ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§è‡§ï‡•ç‡§∂‡§® ‡§ï‡•ã ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§™‡§∞ ‡§≠‡•á‡§ú‡•á‡§Ç
        let userActionTimer;
        
        // ‡§Ø‡§π ‡§´‡•ç‡§≤‡•à‡§ó ‡§π‡§Æ‡•á‡§Ç ‡§≤‡•Ç‡§™ ‡§∏‡•á ‡§¨‡§ö‡§æ‡§§‡§æ ‡§π‡•à
        audio.userControl = true;

        const sendControl = (action) => {
             // 1 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§ï‡§Ç‡§ü‡•ç‡§∞‡•ã‡§≤ ‡§ï‡•ã ‡§¨‡•ç‡§≤‡•â‡§ï ‡§ï‡§∞‡•á‡§Ç ‡§§‡§æ‡§ï‡§ø ‡§∏‡§ø‡§Ç‡§ï ‡§ï‡§Æ‡§æ‡§Ç‡§° ‡§Ü ‡§∏‡§ï‡•á
             audio.userControl = true;
             clearTimeout(userActionTimer);
             userActionTimer = setTimeout(() => {
                 audio.userControl = true;
             }, 1000);
            
             socket.emit('control_stream', {
                 chat_id: chat_id,
                 action: action,
                 time: audio.currentTime
             });
             statusMessage.textContent = `You commanded: ${action}`;
        };

        audio.onplay = () => sendControl('play');
        audio.onpause = () => sendControl('pause');
        
        // ‡§∏‡•Ä‡§ï‡§ø‡§Ç‡§ó (Seeking) ‡§ï‡•á ‡§≤‡§ø‡§è:
        audio.onseeking = () => sendControl('seek');
        
        // 6. Telegram Web App SDK initialization (Same as before)
        window.onload = function() {
            if (window.Telegram && window.Telegram.WebApp) {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                Telegram.WebApp.MainButton.setText("Close Player").show().onClick(function() {
                    Telegram.WebApp.close();
                });
            }
        };
    </script>
</body>
</html>
