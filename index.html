<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pixel Music Pro - Purple Edition</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        :root { --green: #1DB954; --purple: #6a1b9a; --black: #000; --text-main: #fff; --text-dim: #b3b3b3; }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; font-family: 'Segoe UI', sans-serif; 
            background: var(--black); color: var(--text-main); 
            overflow: hidden; height: 100dvh; 
        }

        /* Animated Purple Background */
        #bg-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: radial-gradient(circle at 50% 50%, #4a148c 0%, #000 100%); 
            z-index: -1; transition: 1.5s ease; opacity: 0.8;
            animation: pulseBg 8s infinite alternate;
        }
        @keyframes pulseBg {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }

        /* Moving Icons Animation */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }
        .moving-icon { animation: float 3s ease-in-out infinite; }
        
        .view { display: none; height: calc(100dvh - 170px); overflow-y: auto; padding: 20px 15px; }
        .view.active { display: block; animation: slideUp 0.4s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Custom Header */
        header { padding: 45px 20px 10px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 30px; font-weight: 900; letter-spacing: -1.5px; }
        .logo span { color: var(--green); text-shadow: 0 0 10px var(--green); }

        /* Custom Jam Section */
        .jam-bar { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; margin: 10px 15px; display: flex; gap: 12px; border: 1px solid rgba(255,255,255,0.1); }
        .jam-btn { flex: 1; padding: 14px; border-radius: 10px; border: none; font-weight: 800; font-size: 14px; transition: 0.3s; }
        .btn-create { background: var(--green); color: #000; box-shadow: 0 4px 15px rgba(29,185,84,0.3); }
        .btn-join { background: #333; color: #fff; }

        /* Grid & Cards */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .card { background: #121212; border-radius: 12px; overflow: hidden; border: 1px solid #222; }
        .card img { width: 100%; aspect-ratio: 1/1; object-fit: cover; }
        .card-body { padding: 12px; font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Mini Player */
        #mini-player {
            position: fixed; bottom: 95px; left: 10px; right: 10px; height: 65px;
            background: rgba(40, 40, 40, 0.95); backdrop-filter: blur(10px);
            border-radius: 12px; display: none; align-items: center; padding: 0 15px; z-index: 1000;
            border: 1px solid rgba(255,255,255,0.1);
        }
        #mini-player img { width: 48px; height: 48px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }

        /* Full Player Overlay */
        #player-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100dvh; 
            background: linear-gradient(to bottom, #4a148c, #000); 
            z-index: 2000; transform: translateY(100%); transition: 0.6s cubic-bezier(0.19, 1, 0.22, 1);
            padding: 50px 25px; display: flex; flex-direction: column;
        }
        #player-overlay.active { transform: translateY(0); }
        .main-art { width: 100%; aspect-ratio: 1/1; border-radius: 15px; margin: 40px 0; box-shadow: 0 25px 60px rgba(0,0,0,0.8); animation: pulseArt 4s infinite alternate; }
        
        @keyframes pulseArt { from { transform: scale(1); } to { transform: scale(1.03); } }

        /* Bottom Nav */
        .nav { position: fixed; bottom: 0; width: 100%; height: 85px; background: rgba(0,0,0,0.98); display: flex; justify-content: space-around; align-items: center; z-index: 1500; border-top: 1px solid #111; }
        .nav-item { text-align: center; color: var(--text-dim); font-size: 12px; font-weight: 600; transition: 0.3s; }
        .nav-item.active { color: #fff; transform: scale(1.1); }
        .nav-item svg { width: 30px; height: 30px; display: block; margin: 0 auto 5px; transition: 0.3s; }

        /* Play Button */
        .play-main { width: 75px; height: 75px; border-radius: 50%; background: #fff; display: flex; align-items: center; justify-content: center; border: none; box-shadow: 0 0 20px rgba(255,255,255,0.2); }

        #yt-hidden { position: fixed; left: -9999px; }
    </style>
</head>
<body>

<div id="yt-hidden"><div id="player"></div></div>
<div id="bg-overlay"></div>

<header>
    <div class="logo moving-icon">Pixel<span>.</span></div>
    <div style="background: rgba(255,255,255,0.1); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
        <svg fill="white" width="24" height="24" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
    </div>
</header>

<div class="jam-bar" id="jam-controls">
    <button class="jam-btn btn-create moving-icon" onclick="customCreateJam()">Create My Jam</button>
    <button class="jam-btn btn-join" onclick="customJoinJam()">Join a Room</button>
</div>

<div id="home-view" class="view active">
    <h2 style="font-size: 26px;">Recommended</h2>
    <div class="grid" id="home-grid"></div>
    <h3 style="margin-top:30px">Trending Now</h3>
    <div id="home-list"></div>
</div>

<div id="search-view" class="view">
    <div style="background: #fff; border-radius: 10px; display: flex; align-items: center; padding: 15px; margin-bottom: 25px;">
        <input id="q" placeholder="Search Artists or Songs" style="border:none; outline:none; width:100%; font-size:18px; color:#000; font-weight:600;" onkeyup="if(event.key==='Enter') doSearch()">
    </div>
    <div id="search-results"></div>
</div>

<div id="mini-player" onclick="toggleFull(true)">
    <img id="m-img" src="">
    <div style="flex:1; margin:0 15px; overflow:hidden;">
        <h5 id="m-title" style="margin:0; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Song Name</h5>
    </div>
    <button style="background:none; border:none; color:white;" onclick="togglePlay(event)">
        <svg id="m-play" viewBox="0 0 24 24" width="35" height="35" fill="white"><path d="M8 5v14l11-7z"/></svg>
    </button>
</div>

<div class="nav">
    <div class="nav-item active" onclick="tab('home', this)">
        <svg class="moving-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>Home
    </div>
    <div class="nav-item" onclick="tab('search', this)">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>Search
    </div>
</div>

<div id="player-overlay">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <svg onclick="toggleFull(false)" width="35" height="35" fill="white" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
        <div id="jam-tag" style="font-size: 11px; font-weight: 800; background: rgba(29,185,84,0.2); color: var(--green); padding: 6px 12px; border-radius: 20px;">PIXEL PREMIUM</div>
        <div width="35"></div>
    </div>

    <img id="f-img" class="main-art">

    <div>
        <h2 id="f-title" style="margin:0; font-size:26px;">Song Title</h2>
        <p id="f-artist" style="color:var(--text-dim); margin:10px 0; font-size:18px;">Artist</p>
    </div>

    <div style="margin-top:40px;">
        <input type="range" id="seek" value="0" style="width:100%; accent-color:#fff;" onchange="seekTo(this.value)">
        <div style="display:flex; justify-content:space-between; font-size:12px; margin-top:10px; font-weight:bold; color:var(--text-dim);">
            <span id="cur">0:00</span>
            <span id="dur">0:00</span>
        </div>
    </div>

    <div style="display: flex; justify-content: space-around; align-items: center; margin-top: 50px;">
        <svg width="40" height="40" fill="white" onclick="skip(-10)" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
        <button class="play-main" onclick="togglePlay(event)">
            <svg id="f-play" width="40" height="40" fill="black" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        </button>
        <svg width="40" height="40" fill="white" onclick="skip(10)" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
    </div>
</div>

<script>
    let yt, apiKey, currentId, jamRoom = null;
    const socket = io();

    function onYouTubeIframeAPIReady() {
        yt = new YT.Player('player', { 
            height: '0', width: '0', 
            playerVars: { 'autoplay': 1, 'controls': 0 },
            events: { 'onStateChange': stateChange, 'onReady': () => console.log("Engine Ready") } 
        });
    }

    async function init() {
        const res = await fetch("/api/config");
        const data = await res.json();
        apiKey = data.yt;
        loadHome();
    }

    async function loadHome() {
        const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=Bollywood%20Songs%202025&type=video&maxResults=10&key=${apiKey}`);
        const data = await res.json();
        
        document.getElementById("home-grid").innerHTML = data.items.slice(0, 4).map(v => `
            <div class="card" onclick="play('${v.id.videoId}','${v.snippet.title.replace(/'/g,"")}','${v.snippet.thumbnails.high.url}','${v.snippet.channelTitle}')">
                <img src="${v.snippet.thumbnails.medium.url}">
                <div class="card-body">${v.snippet.title}</div>
            </div>`).join('');
        
        renderList(data.items.slice(4), "home-list");
    }

    async function doSearch() {
        const query = document.getElementById("q").value;
        const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${query}&type=video&maxResults=15&key=${apiKey}`);
        const data = await res.json();
        renderList(data.items, "search-results");
    }

    function renderList(items, target) {
        document.getElementById(target).innerHTML = items.map(v => `
            <div style="display:flex; align-items:center; padding:12px 0; border-bottom:1px solid #111;" onclick="play('${v.id.videoId}','${v.snippet.title.replace(/'/g,"")}','${v.snippet.thumbnails.high.url}','${v.snippet.channelTitle}')">
                <img src="${v.snippet.thumbnails.medium.url}" style="width:55px; height:55px; border-radius:8px; margin-right:15px;">
                <div style="flex:1; overflow:hidden;">
                    <h4 style="margin:0; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${v.snippet.title}</h4>
                    <p style="margin:4px 0 0; color:#b3b3b3; font-size:12px;">${v.snippet.channelTitle}</p>
                </div>
            </div>`).join('');
    }

    function play(id, title, img, artist, isSync = false) {
        currentId = id;
        yt.loadVideoById(id);
        document.getElementById("mini-player").style.display = "flex";
        document.getElementById("m-img").src = img; document.getElementById("f-img").src = img;
        document.getElementById("m-title").innerText = title; document.getElementById("f-title").innerText = title;
        document.getElementById("f-artist").innerText = artist;
        
        if(!isSync && jamRoom) socket.emit("sync-play", { room: jamRoom, id, title, img, artist });
        toggleFull(true);
    }

    function stateChange(e) {
        const p1 = document.getElementById("f-play");
        const p2 = document.getElementById("m-play");
        const pausePath = "M6 19h4V5H6v14zm8-14v14h4V5h-4z";
        const playPath = "M8 5v14l11-7z";

        if(e.data === 1) {
            p1.innerHTML = `<path d="${pausePath}"/>`; p2.innerHTML = `<path d="${pausePath}"/>`;
            updateSeek();
        } else {
            p1.innerHTML = `<path d="${playPath}"/>`; p2.innerHTML = `<path d="${playPath}"/>`;
        }

        // AUTO-PLAY NEXT SONG Logic
        if(e.data === 0) {
            console.log("Song Ended. Finding next...");
            playNext();
        }
    }

    async function playNext() {
        const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&relatedToVideoId=${currentId}&type=video&maxResults=1&key=${apiKey}`);
        const data = await res.json();
        if(data.items && data.items.length > 0) {
            const v = data.items[0];
            play(v.id.videoId, v.snippet.title, v.snippet.thumbnails.high.url, v.snippet.channelTitle);
        } else {
            // Fallback: search trending if no related found
            loadHome();
        }
    }

    // CUSTOM JAM MODE
    function customCreateJam() {
        const myName = prompt("Enter your Name (Jam Creator):", "User");
        const myId = prompt("Enter a unique Jam ID (e.g. MyParty123):", "PIXEL_" + Math.floor(Math.random()*999));
        
        if(myId) {
            jamRoom = myId.toUpperCase();
            socket.emit("join", jamRoom);
            document.getElementById("jam-tag").innerText = "JAM ROOM: " + jamRoom;
            document.getElementById("jam-tag").style.background = "#1DB954";
            document.getElementById("jam-tag").style.color = "#000";
            alert(`Jam Room '${jamRoom}' created by ${myName}! Share this ID to sync.`);
        }
    }

    function customJoinJam() {
        const id = prompt("Enter the Room ID to Join:");
        if(id) {
            jamRoom = id.toUpperCase();
            socket.emit("join", jamRoom);
            document.getElementById("jam-tag").innerText = "CONNECTED TO: " + jamRoom;
            document.getElementById("jam-tag").style.background = "#1DB954";
            document.getElementById("jam-tag").style.color = "#000";
            alert("Successfully joined Jam: " + jamRoom);
        }
    }

    function updateSeek() {
        const bar = document.getElementById("seek");
        bar.max = yt.getDuration();
        document.getElementById("dur").innerText = formatTime(yt.getDuration());
        const timer = setInterval(() => {
            if(yt.getPlayerState() !== 1) { clearInterval(timer); return; }
            bar.value = yt.getCurrentTime();
            document.getElementById("cur").innerText = formatTime(yt.getCurrentTime());
        }, 1000);
    }

    function formatTime(s) { let m = Math.floor(s/60); let sec = Math.floor(s%60); return `${m}:${sec < 10 ? '0'+sec : sec}`; }
    function togglePlay(e) { e.stopPropagation(); if(yt.getPlayerState() === 1) yt.pauseVideo(); else yt.playVideo(); }
    function tab(t, el) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(t + '-view').classList.add('active');
        el.classList.add('active');
        document.querySelector("header").style.display = (t === 'search') ? 'none' : 'flex';
        document.getElementById("jam-controls").style.display = (t === 'home') ? 'flex' : 'none';
    }
    function toggleFull(s) { document.getElementById("player-overlay").classList.toggle("active", s); }
    function seekTo(v) { yt.seekTo(v, true); }
    function skip(s) { yt.seekTo(yt.getCurrentTime() + s, true); }

    socket.on("play", d => play(d.id, d.title, d.img, d.artist, true));
    init();
</script>
</body>
</html>
