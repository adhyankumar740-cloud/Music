<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pixel Music - Spotify Edition</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        :root { --spotify-green: #1DB954; --bg-black: #000000; --surface: #121212; --card-hover: #282828; --text-muted: #b3b3b3; }
        
        body { margin: 0; font-family: 'Circular Std', 'Helvetica Neue', sans-serif; background: var(--bg-black); color: white; -webkit-tap-highlight-color: transparent; }
        
        /* Navigation & Header */
        .nav-header { padding: 20px 15px; font-size: 24px; font-weight: bold; background: linear-gradient(to bottom, #222, var(--bg-black)); position: sticky; top: 0; z-index: 50; }
        
        /* Search Styling */
        .search-box { padding: 10px 15px; }
        .search-bar { background: #fff; border-radius: 4px; display: flex; align-items: center; padding: 12px 15px; color: #000; font-weight: 500; }
        .search-bar input { border: none; outline: none; width: 100%; margin-left: 10px; font-size: 16px; }

        /* Song List View (Spotify style results) */
        .section-label { padding: 20px 15px 10px; font-size: 18px; font-weight: bold; }
        .song-list-item { display: flex; align-items: center; padding: 10px 15px; transition: 0.2s; }
        .song-list-item:active { background: var(--card-hover); }
        .song-list-item img { width: 48px; height: 48px; border-radius: 4px; object-fit: cover; }
        .song-meta { margin-left: 12px; flex: 1; overflow: hidden; }
        .song-meta h4 { margin: 0; font-size: 16px; font-weight: 400; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .song-meta p { margin: 4px 0 0; font-size: 13px; color: var(--text-muted); }

        /* Full Player Overlay (Spotify Mobile Layout) */
        #player-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(to bottom, #333, #000); 
            z-index: 1000; transform: translateY(100%); transition: 0.4s ease-out;
            padding: 20px; box-sizing: border-box; display: flex; flex-direction: column;
        }
        #player-overlay.active { transform: translateY(0); }
        .player-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        
        .artwork-wrapper { width: 100%; aspect-ratio: 1/1; padding: 10px; box-sizing: border-box; margin-bottom: 40px; }
        .artwork-wrapper img { width: 100%; height: 100%; border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.5); }
        
        .now-playing-info h2 { margin: 0; font-size: 24px; }
        .now-playing-info p { margin: 8px 0; color: var(--text-muted); font-size: 16px; }

        /* Controls */
        .progress-area { margin-top: 30px; }
        #seek-bar { width: 100%; accent-color: #fff; height: 4px; }
        .time-labels { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-muted); margin-top: 8px; }

        .player-controls { display: flex; justify-content: space-around; align-items: center; margin-top: 30px; }
        .play-btn { width: 64px; height: 64px; border-radius: 50%; background: #fff; color: #000; display: flex; align-items: center; justify-content: center; font-size: 24px; border: none; }
        .side-btn { background: none; border: none; color: #fff; font-size: 28px; }

        /* Mini Player Bottom Bar */
        #mini-player {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 64px;
            background: #222; display: none; align-items: center; padding: 0 10px;
            box-sizing: border-box; border-bottom: 1px solid #000; z-index: 500;
        }
        #mini-player img { width: 40px; height: 40px; border-radius: 4px; }
        .mini-content { flex: 1; margin: 0 12px; overflow: hidden; }
        .mini-content h5 { margin: 0; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .mini-content p { margin: 2px 0 0; font-size: 12px; color: var(--text-muted); }

        /* Hidden YT */
        #yt-api { position: absolute; top: -100px; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

<div id="yt-api"><div id="player"></div></div>

<div id="main-view">
    <div class="nav-header">Good morning</div>
    
    <div class="search-box">
        <div class="search-bar">
            <span>üîç</span>
            <input id="search-input" placeholder="What do you want to listen to?" onkeyup="if(event.key==='Enter') searchSongs()">
        </div>
    </div>

    <div class="section-label" id="results-label">Trending now</div>
    <div id="song-list">
        </div>

    <div style="padding: 20px; text-align: center;">
        <button onclick="startJam()" style="background:none; border: 1px solid #555; color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px;">Start Jam Room üë•</button>
    </div>
</div>

<div id="mini-player" onclick="openFullPlayer()">
    <img id="m-img" src="">
    <div class="mini-content">
        <h5 id="m-title">Song Title</h5>
        <p id="m-artist">Artist Name</p>
    </div>
    <button class="side-btn" onclick="togglePlay(event)" id="m-play-btn" style="font-size: 20px; margin-right: 10px;">‚ñ∂</button>
</div>

<div id="player-overlay">
    <div class="player-nav">
        <span onclick="closeFullPlayer()" style="font-size: 30px;">‚åÑ</span>
        <span style="font-size: 12px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">Playing from Search</span>
        <span>...</span>
    </div>

    <div class="artwork-wrapper">
        <img id="f-img" src="">
    </div>

    <div class="now-playing-info">
        <h2 id="f-title">Song Title</h2>
        <p id="f-artist">Artist Name</p>
    </div>

    <div class="progress-area">
        <input type="range" id="seek-bar" value="0" step="1" onchange="seekTo(this.value)">
        <div class="time-labels">
            <span id="time-curr">0:00</span>
            <span id="time-total">0:00</span>
        </div>
    </div>

    <div class="player-controls">
        <button class="side-btn" onclick="skip(-10)">‚èÆ</button>
        <button class="play-btn" onclick="togglePlay(event)" id="f-play-btn">‚ñ∂</button>
        <button class="side-btn" onclick="skip(10)">‚è≠</button>
    </div>
    
    <div style="margin-top: 40px; text-align: center; color: var(--spotify-green); font-size: 14px; font-weight: bold;">
        <span id="jam-status"></span>
    </div>
</div>

<script>
    let ytPlayer, currentId, apiKey, jamRoom = null;
    const socket = io();

    function onYouTubeIframeAPIReady() {
        ytPlayer = new YT.Player('player', {
            height: '0', width: '0',
            events: { 'onStateChange': onStateChange }
        });
    }

    async function init() {
        const res = await fetch("/api/config");
        const data = await res.json();
        apiKey = data.yt;
        searchSongs("Arijit Singh Mix"); // Default landing songs
    }

    async function searchSongs(query) {
        const q = query || document.getElementById("search-input").value;
        if(!q) return;
        
        const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${q}&type=video&maxResults=15&key=${apiKey}`);
        const data = await res.json();
        
        const listContainer = document.getElementById("song-list");
        listContainer.innerHTML = data.items.map(v => `
            <div class="song-list-item" onclick="playMusic('${v.id.videoId}', '${v.snippet.title.replace(/'/g,"")}', '${v.snippet.thumbnails.high.url}', '${v.snippet.channelTitle}')">
                <img src="${v.snippet.thumbnails.medium.url}">
                <div class="song-meta">
                    <h4>${v.snippet.title}</h4>
                    <p>${v.snippet.channelTitle}</p>
                </div>
                <span style="color: #b3b3b3;">...</span>
            </div>
        `).join('');
    }

    function playMusic(id, title, img, artist, isSync = false) {
        currentId = id;
        ytPlayer.loadVideoById(id);
        
        // Update All UI elements
        document.getElementById("mini-player").style.display = "flex";
        document.getElementById("m-title").innerText = title;
        document.getElementById("f-title").innerText = title;
        document.getElementById("m-img").src = img;
        document.getElementById("f-img").src = img;
        document.getElementById("m-artist").innerText = artist;
        document.getElementById("f-artist").innerText = artist;

        if(!isSync && jamRoom) {
            socket.emit("sync-play", { room: jamRoom, id, title, img, artist });
        }
    }

    function togglePlay(e) {
        e.stopPropagation();
        const state = ytPlayer.getPlayerState();
        if(state === 1) { ytPlayer.pauseVideo(); } else { ytPlayer.playVideo(); }
    }

    function onStateChange(e) {
        const fBtn = document.getElementById("f-play-btn");
        const mBtn = document.getElementById("m-play-btn");
        
        if(e.data === 1) { // Playing
            fBtn.innerText = "‚è∏"; mBtn.innerText = "‚è∏";
            updateProgress();
        } else {
            fBtn.innerText = "‚ñ∂"; mBtn.innerText = "‚ñ∂";
        }
        
        if(e.data === 0) playNextRelated(); // Autoplay next
    }

    function updateProgress() {
        const bar = document.getElementById("seek-bar");
        bar.max = Math.floor(ytPlayer.getDuration());
        document.getElementById("time-total").innerText = formatTime(ytPlayer.getDuration());
        
        setInterval(() => {
            const curr = ytPlayer.getCurrentTime();
            bar.value = curr;
            document.getElementById("time-curr").innerText = formatTime(curr);
        }, 1000);
    }

    async function playNextRelated() {
        const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&relatedToVideoId=${currentId}&type=video&maxResults=1&key=${apiKey}`);
        const data = await res.json();
        if(data.items.length > 0) {
            const v = data.items[0];
            playMusic(v.id.videoId, v.snippet.title, v.snippet.thumbnails.high.url, v.snippet.channelTitle);
        }
    }

    function formatTime(s) {
        let min = Math.floor(s / 60);
        let sec = Math.floor(s % 60);
        return `${min}:${sec < 10 ? '0'+sec : sec}`;
    }

    function openFullPlayer() { document.getElementById("player-overlay").classList.add("active"); }
    function closeFullPlayer() { document.getElementById("player-overlay").classList.remove("active"); }
    function seekTo(val) { ytPlayer.seekTo(val, true); }
    function skip(s) { ytPlayer.seekTo(ytPlayer.getCurrentTime() + s, true); }

    function startJam() {
        jamRoom = prompt("Jam Room Name:");
        if(jamRoom) {
            socket.emit("join", jamRoom);
            document.getElementById("jam-status").innerText = "CONNECTED TO JAM: " + jamRoom;
        }
    }

    socket.on("play", d => playMusic(d.id, d.title, d.img, d.artist, true));
    
    init();
</script>
</body>
</html>
