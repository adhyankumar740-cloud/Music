<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pixel Music</title>
<script src="https://www.youtube.com/iframe_api"></script>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#121212;color:#fff;}
.header{text-align:center;padding:20px;font-size:24px;font-weight:bold;}
#loginPanel,#app{display:none;}
input,button{padding:8px;margin:5px;border-radius:5px;border:none;}
button{cursor:pointer;background:#1DB954;color:#000;font-weight:bold;}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:10px;overflow-y:auto;max-height:50vh;}
.card{background:#181818;border-radius:10px;overflow:hidden;cursor:pointer;}
.card img{width:100%;}
.card p{margin:5px;font-size:14px;}
.player{position:fixed;bottom:0;width:100%;background:#181818;padding:10px;display:flex;flex-direction:column;}
.controls{display:flex;justify-content:space-around;align-items:center;}
.controls button{font-size:22px;}
</style>
</head>

<body>
<div class="header">Pixel Music</div>

<div id="loginPanel" style="text-align:center;">
<h3>Login / Register</h3>
<input id="username" placeholder="Username"><br>
<input id="password" type="password" placeholder="Password"><br>
<button onclick="register()">Register</button>
<button onclick="login()">Login</button>
<div id="loginMsg"></div>
</div>

<div id="app">
<div id="current-song" style="text-align:center;margin-bottom:5px;">No song playing</div>
<div class="grid" id="grid">
<p id="loading">Loading songs...</p>
</div>
<div>
<h4>Playlists</h4>
<input id="plName" placeholder="New Playlist"><button onclick="createPlaylist()">Add</button>
<div id="playlists"></div>
</div>
<div class="player">
<input type="range" id="seek" value="0" style="width:100%">
<div class="controls">
<button onclick="seek(-10)">‚èÆ</button>
<button id="playBtn" onclick="playPause()">‚ñ∂</button>
<button onclick="seek(10)">‚è≠</button>
<button onclick="joinJam()">üéµ</button>
</div>
</div>
</div>

<div id="yt" style="display:none"></div>

<script>
let yt, playing=false, videoId="", room="pixel", user=null;
const socket=io();

// YouTube Player
function onYouTubeIframeAPIReady(){yt=new YT.Player("yt",{events:{onReady:init,onStateChange:onPlayerState}});}

// Login/Register
function register(){
    fetch("/api/register",{method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({username:document.getElementById("username").value,password:document.getElementById("password").value})})
    .then(r=>r.json()).then(d=>{if(d.ok){login();}else loginMsg("Username taken")});
}
function login(){
    fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({username:document.getElementById("username").value,password:document.getElementById("password").value})})
    .then(r=>r.json()).then(d=>{
        if(d.ok){user=d;document.getElementById("loginPanel").style.display="none";document.getElementById("app").style.display="block";loadPlaylists();init();}
        else loginMsg("Invalid credentials");
    });
}
function loginMsg(msg){document.getElementById("loginMsg").innerText=msg;}

// YouTube + Fetch Songs
async function init(){
    const r=await fetch("/api/config"); const d=await r.json();
    const res=await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=bollywood&type=video&maxResults=8&key=${d.yt}`);
    const data=await res.json();
    if(data.items && data.items.length>0){
        renderSongs(data.items);
        document.getElementById("loading").style.display="none";
    } else document.getElementById("loading").innerText="No songs found";
}

function renderSongs(list){
    const g=document.getElementById("grid");
    g.innerHTML="";
    list.forEach(v=>{
        g.innerHTML+=`<div class="card" onclick="play('${v.id.videoId}','${v.snippet.title}')">
        <img src="${v.snippet.thumbnails.high.url}"><p>${v.snippet.title}</p></div>`;
    });
}

// Play Song
function play(id,title){
    videoId=id;
    yt.loadVideoById(id);
    document.getElementById("current-song").innerText=title;
    playing=true;
    document.getElementById("playBtn").innerText="‚è∏";
    socket.emit("play",{roomId:room,videoId:id,time:0,playing:true});
}

// Play/Pause
function playPause(){
    if(!videoId) return;
    if(playing){ yt.pauseVideo(); document.getElementById("playBtn").innerText="‚ñ∂"; socket.emit("pause",room);}
    else{ yt.playVideo(); document.getElementById("playBtn").innerText="‚è∏"; socket.emit("play",{roomId:room,videoId,time:yt.getCurrentTime(),playing:true});}
    playing=!playing;
}

// Seek
function seek(t){if(!videoId) return; yt.seekTo(yt.getCurrentTime()+t,true); socket.emit("seek",{roomId:room,time:yt.getCurrentTime()});}

// Player State
function onPlayerState(e){
    if(e.data==YT.PlayerState.PLAYING){
        const seekInput=document.getElementById("seek");
        seekInput.max=yt.getDuration();
        setInterval(()=>{seekInput.value=yt.getCurrentTime();},1000);
    }
}

// Jam Mode
function joinJam(){socket.emit("join",room); alert("Joined Jam Room!");}
socket.on("play",d=>{yt.loadVideoById(d.videoId,d.time); document.getElementById("playBtn").innerText="‚è∏"; playing=true;});
socket.on("pause",()=>{yt.pauseVideo(); document.getElementById("playBtn").innerText="‚ñ∂"; playing=false;});
socket.on("seek",t=>{yt.seekTo(t,true);});

// Playlists
async function createPlaylist(){
    const name=document.getElementById("plName").value;
    if(!name) return;
    await fetch("/api/playlist",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:user.username,name})});
    loadPlaylists();
}
async function loadPlaylists(){
    const res=await fetch("/api/playlists/"+user.username);
    const pls=await res.json();
    const container=document.getElementById("playlists");
    container.innerHTML="";
    pls.forEach(p=>{
        let html=`<div style="margin:5px;padding:5px;background:#242424;border-radius:5px;">
        <b>${p.name}</b> <button onclick="addToPlaylist('${p._id}')">Add current</button>
        <div>${p.songs.map(s=>"<p>"+s+"</p>").join("")}</div></div>`;
        container.innerHTML+=html;
    });
}
async function addToPlaylist(id){
    if(!videoId) return alert("No song playing");
    await fetch("/api/playlist/add",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id,videoId})});
    loadPlaylists();
}
</script>
</body>
</html>
